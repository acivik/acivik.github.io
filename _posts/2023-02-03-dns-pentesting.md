---
title: 53 - DNS Pentesting
author: Acivik
date: 2023-02-03 19:00:00 +0300 
categories: [Pentesting, Enumeration, Protokoller]
tags: [DNS, 53/tcp, 53/udp, enumeration, pentest, exploit, scan, protocols, protokoller]
---

# DNS Nedir?

![https://i.ibb.co/kq5fSjd/image.png](https://i.ibb.co/kq5fSjd/image.png)

DNS(Domain Name System), internetin telefon rehberi diyebiliriz. Biz bir websitesine giderken genellikle alan adlarını (ex. example.com) kullanırız. DNS ise gitmek istediğimiz alan adının ip adresini söyler ve biz de o adrese gideriz.

İnternete bağlı olan her cihaz benzersiz bir ip adresine sahiptir ve bu adresler üzerinden iletişime geçebilirler. DNS olmasaydı ziyaret edeceğimiz web sunucularının ip adreslerini ezberlemek zorunda kalacaktık. Günümüzde DNS bizi bu durumdan kurtarır.


> Genellikle 53 numaralı port üzerinde çalışır.
{: .prompt-tip }

```bash
PORT     STATE SERVICE  REASON
53/tcp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
53/udp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
```

# DNS Nasıl Çalışır?

1. Kullanıcı, tarayıcıya bir adres girer. Örneğin example.com. Bu sorgu bir dns çözümleyici tarafından alınır.
2. Çözümleyici sorguyu root DNS sunucusuna iletir.
3. Root DNS Sorguya TLD DNS’in adresi ile yanıt verir. example.com için TLD `.com`'dur.
4. Çözümleyici TLD adresine sorgu gönderir.
5. TLD sunucusu, alan adının NS (Name Server) IP adresi ile yanıt verir.
6. DNS çözümleyici alan adının NS’ine sorgu gönderir.
7. Sonrasında NS, alan adının IP adresini çözümleyiciye gönderir.
8. DNS çözümleyici IP adresini kullanıcıya döndürür.
9. Tarayıcı IP adresine HTTP isteğinde bulunur.
10. Web sunucusu kullanıcıya response döndürür.

![https://i.ibb.co/SmZSHcG/dns-lookup-diagram.png](https://i.ibb.co/SmZSHcG/dns-lookup-diagram.png)

# DNS Kayıt Türleri

DNS sunucuları, host veya domain hakkında önemli bilgiler sağlamak için bir DNS kaydı oluşturur. En yaygın DNS kayıt türleri şunlardır:

| DNS Kayıt Türü | Methodu | Açıklaması |
| :---: | :---: | :--- |
| Address Record | A | 32 bitlik bir IPv4 adresi döndürür. En yaygın olarak hostname’i hostun IP adresine eşlemek için kullanılır. |
| Canonical Name Record | CNAME | Bir hostnam’i başka bir hosta takma isim olarak eklemek için kullanılır. |
| IPv6 Address Record | AAAA | hostname’i ve karşılık gelen 128 bitlik IPv6 adresini döndürür. |
| Mail Exchange Record | MX | Domainden gönderilen mailin e-posta sunucusuna iletilmesi için kullanılır. SMTP sunucusu belirtilir. |
| Name Server Record | NS | Name Server adresini sağlar. |
| Zone of Authority Record | SOA | Domainin yetkili name server’ini, domain admin’in iletişim bilgilerini, domain’in seri numarasını ve domainin DNS bilgilerinin ne sıklıkta yenilenmesi gerektiğiyle alakalı bilgiler verir. |
| Sender Policy Framework | SPF | E-postanın doğru kaynaktan gelip gelmediğini kontrol etmek için sağlanan bir mekanizmadır. Sahte e-postaların önüne geçmek için kullanılır. |
| Text Record | TXT | Okunabilir bir metin sağlar. |
| Pointer Record | PTR | DNS çözümleyicinin bir IP adresi sağlamasına ve karşılığında hostname almasını sağlar. Reverse DNS lookup. |
| Service Locator | SRV | MX gibi ancak diğer iletişim protokolleri için bir service locator kaydıdır. |
| Next Secure Record | NSEC | Hostname’in var olmadığını kanıtlamak için kullanılır. |
| Authoritative Zone Transfer | AXFR | Zone Transfer NS içerisindeki bilgileri depolamak, kopyalamak, çoğaltmak vs. gibi amaçlar için kullanılır. Bir kullanıcı başarılı şekilde bu isteği gönderdiğinde NS izin veriyorsa tüm bilgileri okunabilir formatta döndürür. |
| Incremental Zone Transfer | IXFR | Master NS’den ikincil bir NS’e zone file transfer eder. |
| Certificate Record | CERT | Encryption Sertifikalarını depolar. (PKIX, SPKI, PGP vb.) |

# 3 DNS Sorgu Türü

1. **Recursive Query:** DNS istemcisi bir hostname sağlar ve DNS çözümleyicisinden bir IP adresi döndürmesi beklenir. DNS çözümleyicisi istenen hostname’in IP adresini ve diğer bilgilerini tutan Authoritative Name Servers’ı bulana kadar Root DNS sunucusuna özyinelemeli bir sorgu başlatır.  
2. **Iterative Query:** Bu sorguda DNS istemcisi bir hostname sağlar ve DNS çözümleyicisi en iyi sonucu döndürmeye çalışır. Bunun için ilk olarak kendi önbelleğini kontrol eder eğer ilgili DNS kayıtları bulunuyorsa sonucu döndürür. Eğer yoksa istemciyi Root DNS’e veya DNS bölgesindeki en yakın Authoritative Name Server’a yönlendirir. Sonrasında DNS istemcisi direkt olarak ilgili DNS’e sorguyu yineler.
3. **Non-Recursive Query:** DNS çözümleyicisinin cevabı bildiği bir durumdur. Önbellekte hali hazırda tutulan kayıtları döndürür veya ilgili Name Server’a bir sorgu iletir. Her iki durumda da ek sorgulara gerek yoktur yani yukarıdaki sorgular kullanılmaz. Hızlı bir sonuç döndürür.

# DNS’e Yönelik Sızma Testi

| <img src="https://www.shodan.io/static/img/favicon.png" width="20px" /> Shodan search query : |
|:-----------------------------|
| `port:53` |
| `port:"53" "Recursion: enabled”` |

```bash
PORT   STATE SERVICE
53/tcp open  domain

PORT   STATE SERVICE
53/udp open  domain
```

## Banner Grabbing

DNS banner bilgisine sahip değildir. Ona yakın başka bir şey `version.bind CHAOS TXT` sorgusudur. 

### **Dig**

```bash
dig version.bind CHAOS TXT @DNS
```

### **Nmap Script**

```bash
--script dns-nsid
```

## Bilgi Toplama ve Tarama

### Diğer Sorgular

```bash
dig ANY @<DNS_IP> <DOMAIN>     #Any information
dig A @<DNS_IP> <DOMAIN>       #Regular DNS request
dig AAAA @<DNS_IP> <DOMAIN>    #IPv6 DNS request
dig TXT @<DNS_IP> <DOMAIN>     #Information
dig MX @<DNS_IP> <DOMAIN>      #Emails related
dig NS @<DNS_IP> <DOMAIN>      #DNS that resolves that name
dig -x 192.168.0.2 @<DNS_IP>   #Reverse lookup
dig -x 2a00:1450:400c:c06::93 @<DNS_IP> #reverse IPv6 lookup
```

- ANY

![https://i.ibb.co/JBJFqPQ/image.png](https://i.ibb.co/JBJFqPQ/image.png)

- A

![https://i.ibb.co/rM677g5/image.png](https://i.ibb.co/rM677g5/image.png)

- TXT

![https://i.ibb.co/TcsFVwm/image.png](https://i.ibb.co/TcsFVwm/image.png)

### nslookup Kullanımı

```bash
nslookup
> SERVER <IP_DNS> #Select dns server
> 127.0.0.1 #Reverse lookup of 127.0.0.1, maybe...
> <IP_MACHINE> #Reverse lookup of a machine, maybe...
```

![https://i.ibb.co/N1G9pZ0/image.png](https://i.ibb.co/N1G9pZ0/image.png)

```bash
nslookup -query=mx '<Domain>' -server '<DNS-IP>'                                                                                                                                                         
nslookup -query=ns '<Domain>'  -server '<DNS-IP>'
nslookup -query=any '<Domain>' -server '<DNS-IP>'
```

### Kullanışlı Metasploit Modülü

```bash
msf6 > use auxiliary/gather/enum_dns #Perform enumeration actions
```

![https://i.ibb.co/NxFHtV7/image.png](https://i.ibb.co/NxFHtV7/image.png)

### Kullanışlı Nmap Scripti

```bash
#Perform enumeration actions
nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" -sU -p53 <IP>
```

![https://i.ibb.co/fNY8dBN/image.png](https://i.ibb.co/fNY8dBN/image.png)

### DNSRecon Kullanımı

```bash
dnsrecon -r 127.0.0.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r 127.0.1.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r <IP_DNS>/24 -n <IP_DNS>   #DNS reverse of all of the addresses
dnsrecon -d active.htb -a -n <IP_DNS> #Zone transfer
```

![https://i.ibb.co/B6yM4YZ/image.png](https://i.ibb.co/B6yM4YZ/image.png)

### Fierce Aracı ile Daha Fazla Bilgi Toplamak

```bash
fierce --domain twitter.com --subdomains accounts admin ads
fierce --domain facebook.com --subdomains admin --traverse 10
fierce --domain facebook.com --subdomains admin --search fb.com fb.net
fierce --domain stackoverflow.com --subdomains mail --connect
fierce --domain facebook.com --wide
fierce --domain zonetransfer.me
fierce --domain zonetransfer.me > output.txt
fierce --dns-servers 10.0.0.1 --range 10.0.0.0/24
```

## DNS Brute Force

```bash
dnsenum --dnsserver <IP_DNS> --enum -p 0 -s 0 -o subdomains.txt -f subdomains-1000.txt <DOMAIN>
dnsrecon -D subdomains-1000.txt -d <DOMAIN> -n <IP_DNS>
dnscan -d <domain> -r -w subdomains-1000.txt #Bruteforce subdomains in recursive way, https://github.com/rbsec/dnscan
```

### Active Directory Servers

```bash
dig -t _gc._tcp.lab.<domain>
dig -t _ldap._tcp.lab.<domain>
dig -t _kerberos._tcp.lab.<domain>
dig -t _kpasswd._tcp.lab.<domain>

# Zone Transfer using dig
# Find AD-DS through DNS

# Global Catalog
dig -t SRV _gc._tcp.lab.<domain>

# LDAP servers
dig -t SRV _ldap._tcp.lab.<domain>

# Kerberos KDC
dig -t SRV _kerberos._tcp.lab.<domain>

# Kerberos password change server
dig -t SRV _kpasswd._tcp.lab.<domain>

nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='<domain>'"
```

### Nmap Scriptleri ile SubDomain Bulmak

```bash
nmap -sSU -p53 --script dns-nsec-enum --script-args dns-nsec-enum.domains=domain.com ns3.isc-sns.info
```

## Yaygın Güvenlik Zafiyetleri

### Zone Transfer

DNS Veri tabanının başka bir DNS veritabanına aktarılması işlemidir. Temel konfigurasyon hatalarından dolayı DNS’de kayıtlı olan alan adları ele geçirilebilir.

```bash
dig axfr @<DNS_IP>
dig axfr @<DNS_IP> <DOMAIN>
fierce --domain <DOMAIN> --dns-servers <DNS_IP>
sudo nmap -Pn -sU --script=dns-check-zone -p 53 <domain> #Port scan and trying zone transfer
```

![https://i.ibb.co/6HKDdCY/image.png](https://i.ibb.co/6HKDdCY/image.png)

### DNS Cache Poisoning

DNS cache poisoning, DNS sorgularının yanlış yanıt döndürmesi ve kullanıcıların yanlış web sitelerine yönlendirilmesi için DNS önbelleğine yanlış bilgi girme eylemidir

DNS çözümleyicileri aldığı yanıtları belli bir süre önbellekte tutar. Bu sayede tekrar tekrar dns sorguları üretmek yerine hızlıca dns istemcisine yanıt verir.

Saldırgan NS taklidi yaparak DNS çözümleyicisine istekte bulunarak ve DNS çözümleyicisinin sorgularına sahte yanıtlar vererek bu saldırıyı gerçekleştirebilir.

![https://i.ibb.co/zmh4CZB/image.png](https://i.ibb.co/zmh4CZB/image.png)

### Windows DNS Server RCE

14 Temmuz 2020 tarihinde Check Point güvenlik araştırmacıları tarafından **CVE-2020-1350** koduyla DNS sunucularını etkileyen kritik bir güvenlik açığı yayımlandı. Windows DNS Sunucularında, istekleri düzgün işleyemediğinden dolayı uzaktan kod yürütme güvenlik açığı bulunmaktadır. Bu güvenlik açığından başarıyla yararlanan bir saldırgan, Yerel Sistem Hesabı'nın bağlamında rasgele kod çalıştırabilir. DNS sunucuları olarak yapılandırılmış Windows sunucuları bu güvenlik açığına karşı risk altındadır.
